<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF工具箱完整版 - 网页版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        
        .container {
            max-width: 1400px; margin: 0 auto; background: white;
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white; padding: 30px; text-align: center;
        }
        
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: bold; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        
        .tabs {
            display: flex; background: #f5f5f5; border-bottom: 1px solid #ddd;
        }
        
        .tab {
            flex: 1; padding: 20px; text-align: center; cursor: pointer;
            font-weight: bold; font-size: 1.1em; transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover { background: #e8e8e8; }
        .tab.active { background: white; border-bottom-color: #2196F3; color: #2196F3; }
        
        .tab-content { display: none; padding: 40px; min-height: 600px; }
        .tab-content.active { display: block; }
        
        .info-box {
            background: #e8f5e8; border: 1px solid #4caf50; border-radius: 10px;
            padding: 20px; margin-bottom: 30px; color: #2e7d32;
        }
        
        .warning-box {
            background: #fff3e0; border: 1px solid #ff9800; border-radius: 10px;
            padding: 20px; margin-bottom: 30px; color: #e65100;
        }
        
        .upload-area {
            border: 3px dashed #2196F3; border-radius: 15px;
            padding: 40px; text-align: center; margin: 30px 0;
            transition: all 0.3s ease; cursor: pointer;
        }
        
        .upload-area:hover { border-color: #1976D2; background: #f3f9ff; }
        .upload-area.dragover { border-color: #4CAF50; background: #f1f8e9; }
        
        .upload-btn {
            background: #2196F3; color: white; border: none;
            padding: 15px 30px; border-radius: 25px;
            font-size: 1.1em; font-weight: bold; cursor: pointer;
            margin: 10px; transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            background: #1976D2; transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        
        .settings-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin: 30px 0;
        }
        
        .setting-card {
            background: #f8f9fa; border-radius: 12px; padding: 20px;
            border: 1px solid #e9ecef; transition: all 0.3s ease;
        }
        
        .setting-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .setting-title {
            font-size: 1.1em; font-weight: bold; margin-bottom: 15px;
            color: #333; display: flex; align-items: center; gap: 8px;
        }
        
        .setting-group { margin: 15px 0; }
        
        .setting-label {
            display: block; margin-bottom: 8px; font-weight: 500; color: #555;
        }
        
        .text-input, .select-input {
            width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 1em; transition: border-color 0.3s ease;
        }
        
        .text-input:focus, .select-input:focus {
            outline: none; border-color: #2196F3; box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .radio-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px; margin-top: 10px;
        }
        
        .radio-option {
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            padding: 8px 12px; border-radius: 6px; transition: background 0.3s ease;
        }
        
        .radio-option:hover { background: rgba(33, 150, 243, 0.1); }
        .radio-option input[type="radio"] { cursor: pointer; }
        
        .file-list {
            background: #f9f9f9; border-radius: 12px; padding: 20px;
            margin: 20px 0; max-height: 500px; overflow-y: auto;
        }
        
        .file-list h3 {
            margin-bottom: 15px; color: #333; display: flex;
            align-items: center; justify-content: space-between;
        }
        
        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: white; border-radius: 10px;
            margin: 10px 0; border-left: 4px solid #2196F3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease; cursor: move;
        }
        
        .file-item:hover { 
            box-shadow: 0 4px 16px rgba(0,0,0,0.15); 
            transform: translateY(-1px);
        }
        
        .file-item.dragging { opacity: 0.5; }
        
        .file-info { flex: 1; }
        .file-name { font-weight: 500; color: #333; margin-bottom: 4px; }
        .file-size { color: #666; font-size: 0.9em; }
        
        .file-actions { display: flex; gap: 8px; }
        
        .action-btn {
            padding: 6px 12px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.9em; transition: all 0.3s ease;
        }
        
        .move-btn { background: #2196F3; color: white; }
        .move-btn:hover { background: #1976D2; }
        
        .remove-btn { background: #f44336; color: white; }
        .remove-btn:hover { background: #d32f2f; }
        
        .convert-btn {
            background: linear-gradient(135deg, #FF5722, #FF7043);
            color: white; border: none; padding: 20px 40px;
            border-radius: 30px; font-size: 1.3em; font-weight: bold;
            cursor: pointer; margin: 30px auto; display: block;
            transition: all 0.3s ease;
        }
        
        .convert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 87, 34, 0.4);
        }
        
        .convert-btn:disabled {
            background: #ccc; cursor: not-allowed; transform: none;
        }
        
        .progress-container { margin: 30px 0; display: none; }
        
        .progress-bar {
            background: #e0e0e0; border-radius: 12px; height: 30px;
            overflow: hidden; margin-bottom: 15px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            height: 100%; width: 0%; transition: width 0.3s ease;
            border-radius: 12px; display: flex; align-items: center;
            justify-content: center; color: white; font-weight: bold;
        }
        
        .progress-text {
            text-align: center; color: #666; font-weight: 500;
            margin-bottom: 10px;
        }
        
        .result-box {
            background: #e8f5e8; border: 2px solid #4caf50;
            border-radius: 12px; padding: 25px; margin: 20px 0;
            color: #2e7d32; display: none;
        }
        
        .error-box {
            background: #ffebee; border: 2px solid #f44336;
            border-radius: 12px; padding: 25px; margin: 20px 0;
            color: #c62828; display: none;
        }
        
        .slider {
            width: 100%; height: 6px; border-radius: 3px;
            background: #ddd; outline: none; margin: 10px 0;
        }
        
        .feature-badge {
            display: inline-block; background: #4CAF50; color: white;
            padding: 4px 8px; border-radius: 12px; font-size: 0.8em;
            margin-left: 8px;
        }
        
        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 2em; }
            .tab-content { padding: 20px; }
            .settings-grid { grid-template-columns: 1fr; }
            .radio-grid { grid-template-columns: 1fr; }
            .file-actions { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>🔧 PDF工具箱完整版</h1>
            <p>图片转PDF增强版 & PDF解密说明 | 完全本地处理，保护您的隐私安全</p>
        </div>

        <!-- 选项卡导航 -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('img2pdf')">
                📷 图片转PDF <span class="feature-badge">增强版</span>
            </div>
            <div class="tab" onclick="switchTab('decrypt')">
                🔓 PDF解密 <span class="feature-badge">技术说明</span>
            </div>
        </div>

        <!-- 图片转PDF选项卡 -->
        <div id="img2pdf" class="tab-content active">
            <div class="info-box">
                💡 <strong>增强功能：</strong> 支持多种合并方向、页面大小、图片排列方式、质量调节，可拖拽排序，完全本地处理
            </div>

            <div class="upload-area" id="imageUploadArea">
                <input type="file" id="imageInput" multiple accept="image/*" style="display: none;">
                <h3>📁 选择图片文件</h3>
                <p>点击选择文件或拖拽图片到此处</p>
                <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                    选择图片文件
                </button>
            </div>

            <div class="settings-grid">
                <!-- 基本设置 -->
                <div class="setting-card">
                    <div class="setting-title">📝 基本设置</div>
                    
                    <div class="setting-group">
                        <label class="setting-label">输出文件名:</label>
                        <input type="text" id="outputPdfName" class="text-input" value="合并图片" placeholder="请输入PDF文件名">
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">排序方式:</label>
                        <div class="radio-grid">
                            <div class="radio-option">
                                <input type="radio" id="sortName" name="sortType" value="name" checked>
                                <label for="sortName">文件名</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="sortDate" name="sortType" value="date">
                                <label for="sortDate">修改时间</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="sortSize" name="sortType" value="size">
                                <label for="sortSize">文件大小</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 页面设置 -->
                <div class="setting-card">
                    <div class="setting-title">📄 页面设置</div>
                    
                    <div class="setting-group">
                        <label class="setting-label">页面大小:</label>
                        <select id="pageSize" class="select-input">
                            <option value="auto">自动适应图片大小</option>
                            <option value="A4">A4 (210×297mm)</option>
                            <option value="A3">A3 (297×420mm)</option>
                            <option value="A5">A5 (148×210mm)</option>
                            <option value="Letter">Letter (216×279mm)</option>
                            <option value="Legal">Legal (216×356mm)</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">页面方向:</label>
                        <div class="radio-grid">
                            <div class="radio-option">
                                <input type="radio" id="orientationPortrait" name="orientation" value="portrait" checked>
                                <label for="orientationPortrait">纵向</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="orientationLandscape" name="orientation" value="landscape">
                                <label for="orientationLandscape">横向</label>
                            </div>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">页边距 (mm):</label>
                        <input type="number" id="pageMargin" class="text-input" value="10" min="0" max="50">
                    </div>
                </div>

                <!-- 图片排列 -->
                <div class="setting-card">
                    <div class="setting-title">🖼️ 图片排列</div>
                    
                    <div class="setting-group">
                        <label class="setting-label">排列方式:</label>
                        <div class="radio-grid">
                            <div class="radio-option">
                                <input type="radio" id="layoutSingle" name="layout" value="single" checked>
                                <label for="layoutSingle">一页一图</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="layoutGrid2x1" name="layout" value="2x1">
                                <label for="layoutGrid2x1">2×1横向</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="layoutGrid1x2" name="layout" value="1x2">
                                <label for="layoutGrid1x2">1×2纵向</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="layoutGrid2x2" name="layout" value="2x2">
                                <label for="layoutGrid2x2">2×2网格</label>
                            </div>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">图片缩放:</label>
                        <div class="radio-grid">
                            <div class="radio-option">
                                <input type="radio" id="scaleFit" name="scale" value="fit" checked>
                                <label for="scaleFit">适应页面</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="scaleFill" name="scale" value="fill">
                                <label for="scaleFill">填充页面</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="scaleOriginal" name="scale" value="original">
                                <label for="scaleOriginal">原始大小</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 高级选项 -->
                <div class="setting-card">
                    <div class="setting-title">⚙️ 高级选项</div>
                    
                    <div class="setting-group">
                        <label class="setting-label">图片质量 (%):</label>
                        <input type="range" id="imageQuality" min="50" max="100" value="90" class="slider">
                        <div style="text-align: center; color: #666; margin-top: 5px;">
                            <span id="qualityValue">90%</span>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">背景颜色:</label>
                        <div class="radio-grid">
                            <div class="radio-option">
                                <input type="radio" id="bgWhite" name="background" value="white" checked>
                                <label for="bgWhite">白色</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="bgTransparent" name="background" value="transparent">
                                <label for="bgTransparent">透明</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="bgCustom" name="background" value="custom">
                                <label for="bgCustom">自定义</label>
                            </div>
                        </div>
                        <input type="color" id="customBgColor" value="#ffffff" style="margin-top: 10px; width: 100%; height: 40px; border: none; border-radius: 6px;">
                    </div>
                </div>
            </div>

            <div id="imageFileList" class="file-list" style="display: none;">
                <h3>
                    选中的图片文件：<span id="imageCount">(0个文件)</span>
                    <div style="font-size: 0.9em; font-weight: normal; color: #666;">
                        💡 拖拽文件可调整顺序
                    </div>
                </h3>
                <div id="imageFiles"></div>
            </div>

            <button id="convertImgBtn" class="convert-btn" onclick="convertImagesToPDF()" disabled>
                🔄 转换为PDF
            </button>

            <div id="imgProgress" class="progress-container">
                <div class="progress-text" id="imgProgressText">处理中...</div>
                <div class="progress-bar">
                    <div id="imgProgressFill" class="progress-fill">0%</div>
                </div>
            </div>

            <div id="imgResult" class="result-box"></div>
            <div id="imgError" class="error-box"></div>
        </div>

        <!-- PDF解密选项卡 -->
        <div id="decrypt" class="tab-content">
            <div class="warning-box">
                <h3>🔐 关于网页版PDF解密功能的技术说明</h3>
                <p><strong>技术限制与现实考量：</strong></p>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li><strong>加密算法复杂性：</strong> PDF使用多种加密算法（RC4、AES等），浏览器JavaScript难以完全支持所有加密类型</li>
                    <li><strong>性能限制：</strong> 大文件解密运算会导致浏览器卡顿甚至崩溃</li>
                    <li><strong>安全风险：</strong> 网页端解密通常需要上传文件到服务器，存在隐私泄露风险</li>
                    <li><strong>功能完整性：</strong> 即使实现解密，也可能失去文本层，变成图片型PDF</li>
                </ul>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #1976d2;">💡 推荐解决方案</h4>
                    <p style="color: #1976d2; margin-top: 10px;">
                        <strong>使用本地GUI版工具进行PDF解密</strong>，它可以：
                    </p>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #1976d2;">
                        <li>完全本地处理，确保数据安全</li>
                        <li>支持所有常见的PDF加密方式</li>
                        <li>保持原始文本层和格式</li>
                        <li>批量处理同密码文件</li>
                        <li>高性能，无文件大小限制</li>
                    </ul>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button disabled style="padding: 15px 30px; background-color: #ccc; color: #666; border: none; border-radius: 25px; font-size: 1.1em; cursor: not-allowed;">
                    🔒 PDF解密 (请使用本地版)
                </button>
                <p style="margin-top: 15px; color: #666;">
                    为了您的数据安全和处理效率，PDF解密功能仅在本地GUI版中提供
                </p>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let selectedImages = [];
        let draggedIndex = -1;

        // 选项卡切换
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // 工具函数
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function naturalSort(a, b) {
            const re = /(\d+)|(\D+)/g;
            const A = String(a.name).match(re);
            const B = String(b.name).match(re);

            for (let i = 0; i < Math.min(A.length, B.length); i++) {
                const aPart = A[i];
                const bPart = B[i];
                const aIsNum = /^\d+$/.test(aPart);
                const bIsNum = /^\d+$/.test(bPart);

                if (aIsNum && bIsNum) {
                    const diff = parseInt(aPart) - parseInt(bPart);
                    if (diff !== 0) return diff;
                } else if (aPart !== bPart) {
                    return aPart.localeCompare(bPart);
                }
            }
            return A.length - B.length;
        }

        // 毫米转点
        function mmToPt(mm) {
            return mm * 2.83464567;
        }

        // ==================== 图片转PDF功能 ====================

        // 图片文件选择处理
        document.getElementById('imageInput').addEventListener('change', function(e) {
            handleImageFiles(Array.from(e.target.files));
        });

        // 图片拖拽处理
        const imageUploadArea = document.getElementById('imageUploadArea');
        imageUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            imageUploadArea.classList.add('dragover');
        });

        imageUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            imageUploadArea.classList.remove('dragover');
        });

        imageUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            imageUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleImageFiles(files);
        });

        function handleImageFiles(files) {
            const newFiles = files.filter(file => 
                !selectedImages.some(existing => existing.name === file.name && existing.size === file.size)
            );

            selectedImages = selectedImages.concat(newFiles);
            sortImages();
            updateImageFileList();
            document.getElementById('convertImgBtn').disabled = selectedImages.length === 0;
            
            // 智能设置文件名
            if (selectedImages.length > 0 && document.getElementById('outputPdfName').value === "合并图片") {
                const firstFileName = selectedImages[0].name.split('.').slice(0, -1).join('.');
                document.getElementById('outputPdfName').value = `${firstFileName}_合并`;
            }
        }

        function sortImages() {
            const sortType = document.querySelector('input[name="sortType"]:checked').value;
            
            switch(sortType) {
                case 'name':
                    selectedImages.sort(naturalSort);
                    break;
                case 'date':
                    selectedImages.sort((a, b) => a.lastModified - b.lastModified);
                    break;
                case 'size':
                    selectedImages.sort((a, b) => a.size - b.size);
                    break;
            }
            
            updateImageFileList();
        }

        function updateImageFileList() {
            const fileList = document.getElementById('imageFileList');
            const filesContainer = document.getElementById('imageFiles');
            const countSpan = document.getElementById('imageCount');
            
            if (selectedImages.length === 0) {
                fileList.style.display = 'none';
                return;
            }
            
            fileList.style.display = 'block';
            countSpan.textContent = `(${selectedImages.length}个文件)`;
            
            filesContainer.innerHTML = '';
            selectedImages.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.draggable = true;
                fileItem.dataset.index = index;
                
                // 拖拽事件
                fileItem.addEventListener('dragstart', function(e) {
                    draggedIndex = index;
                    this.classList.add('dragging');
                });
                
                fileItem.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                });
                
                fileItem.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                fileItem.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const dropIndex = parseInt(this.dataset.index);
                    if (draggedIndex !== dropIndex) {
                        const draggedFile = selectedImages[draggedIndex];
                        selectedImages.splice(draggedIndex, 1);
                        selectedImages.splice(dropIndex, 0, draggedFile);
                        updateImageFileList();
                    }
                });
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${index + 1}. ${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn move-btn" onclick="moveImage(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="action-btn move-btn" onclick="moveImage(${index}, 'down')" ${index === selectedImages.length - 1 ? 'disabled' : ''}>↓</button>
                        <button class="action-btn remove-btn" onclick="removeImage(${index})">删除</button>
                    </div>
                `;
                filesContainer.appendChild(fileItem);
            });
        }

        function moveImage(index, direction) {
            if (direction === 'up' && index > 0) {
                [selectedImages[index], selectedImages[index - 1]] = [selectedImages[index - 1], selectedImages[index]];
            } else if (direction === 'down' && index < selectedImages.length - 1) {
                [selectedImages[index], selectedImages[index + 1]] = [selectedImages[index + 1], selectedImages[index]];
            }
            updateImageFileList();
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImageFileList();
            document.getElementById('convertImgBtn').disabled = selectedImages.length === 0;
        }

        // 排序方式改变事件
        document.querySelectorAll('input[name="sortType"]').forEach(radio => {
            radio.addEventListener('change', sortImages);
        });

        // 质量滑块更新
        document.getElementById('imageQuality').addEventListener('input', function() {
            document.getElementById('qualityValue').textContent = this.value + '%';
        });

        async function convertImagesToPDF() {
            if (selectedImages.length === 0) return;

            const convertBtn = document.getElementById('convertImgBtn');
            const progressContainer = document.getElementById('imgProgress');
            const progressFill = document.getElementById('imgProgressFill');
            const progressText = document.getElementById('imgProgressText');
            const resultBox = document.getElementById('imgResult');
            const errorBox = document.getElementById('imgError');

            // 隐藏之前的结果
            resultBox.style.display = 'none';
            errorBox.style.display = 'none';

            // 显示进度条
            convertBtn.disabled = true;
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';

            try {
                // 获取设置
                const settings = {
                    pageSize: document.getElementById('pageSize').value,
                    orientation: document.querySelector('input[name="orientation"]:checked').value,
                    layout: document.querySelector('input[name="layout"]:checked').value,
                    scale: document.querySelector('input[name="scale"]:checked').value,
                    quality: parseInt(document.getElementById('imageQuality').value) / 100,
                    margin: mmToPt(parseInt(document.getElementById('pageMargin').value)),
                    background: document.querySelector('input[name="background"]:checked').value,
                    customBgColor: document.getElementById('customBgColor').value
                };

                const { PDFDocument, rgb } = PDFLib;
                const pdfDoc = await PDFDocument.create();
                
                // 页面尺寸设置
                let pageWidth, pageHeight;
                const pageSizes = {
                    'A4': [595, 842],
                    'A3': [842, 1191],
                    'A5': [420, 595],
                    'Letter': [612, 792],
                    'Legal': [612, 1008]
                };

                if (settings.pageSize === 'auto') {
                    // 自动适应第一张图片
                    const firstImage = selectedImages[0];
                    const img = new Image();
                    await new Promise(resolve => {
                        img.onload = resolve;
                        img.src = URL.createObjectURL(firstImage);
                    });
                    pageWidth = img.width;
                    pageHeight = img.height;
                    URL.revokeObjectURL(img.src);
                } else {
                    [pageWidth, pageHeight] = pageSizes[settings.pageSize];
                }

                if (settings.orientation === 'landscape') {
                    [pageWidth, pageHeight] = [pageHeight, pageWidth];
                }

                // 处理图片
                const layoutConfig = {
                    'single': { cols: 1, rows: 1 },
                    '2x1': { cols: 2, rows: 1 },
                    '1x2': { cols: 1, rows: 2 },
                    '2x2': { cols: 2, rows: 2 }
                };
                
                const { cols, rows } = layoutConfig[settings.layout];
                const imagesPerPage = cols * rows;
                
                for (let i = 0; i < selectedImages.length; i += imagesPerPage) {
                    const progress = Math.round(((i + imagesPerPage) / selectedImages.length) * 100);
                    progressText.textContent = `处理图片 ${i + 1}-${Math.min(i + imagesPerPage, selectedImages.length)}/${selectedImages.length}`;
                    progressFill.style.width = `${Math.min(progress, 100)}%`;
                    progressFill.textContent = `${Math.min(progress, 100)}%`;
                    
                    const page = pdfDoc.addPage([pageWidth, pageHeight]);
                    
                    // 设置背景色
                    if (settings.background !== 'transparent') {
                        let bgColor;
                        if (settings.background === 'white') {
                            bgColor = rgb(1, 1, 1);
                        } else {
                            const hex = settings.customBgColor;
                            const r = parseInt(hex.substr(1, 2), 16) / 255;
                            const g = parseInt(hex.substr(3, 2), 16) / 255;
                            const b = parseInt(hex.substr(5, 2), 16) / 255;
                            bgColor = rgb(r, g, b);
                        }
                        page.drawRectangle({
                            x: 0, y: 0,
                            width: pageWidth, height: pageHeight,
                            color: bgColor
                        });
                    }
                    
                    // 处理当前页的图片
                    const pageImages = selectedImages.slice(i, i + imagesPerPage);
                    await processImagesOnPage(pdfDoc, page, pageImages, settings, pageWidth, pageHeight, cols, rows);
                    
                    // 短暂延迟，让UI更新
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
                
                progressText.textContent = '生成PDF文件...';
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                
                const pdfBytes = await pdfDoc.save();
                
                // 下载文件
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                let outputFileName = document.getElementById('outputPdfName').value.trim();
                if (!outputFileName) {
                    outputFileName = `合并图片_${selectedImages.length}张`;
                }
                a.href = url;
                a.download = `${outputFileName}.pdf`;
                a.click();
                URL.revokeObjectURL(url);
                
                // 显示成功消息
                resultBox.innerHTML = `
                    <h3>✅ 转换成功！</h3>
                    <p>已成功将 <strong>${selectedImages.length}</strong> 张图片转换为PDF文件</p>
                    <p><strong>设置详情：</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>页面大小：${settings.pageSize === 'auto' ? '自动适应' : settings.pageSize}</li>
                        <li>页面方向：${settings.orientation === 'portrait' ? '纵向' : '横向'}</li>
                        <li>排列方式：${settings.layout}</li>
                        <li>图片质量：${Math.round(settings.quality * 100)}%</li>
                    </ul>
                    <p>文件已开始下载，请查看浏览器下载文件夹</p>
                    <p>PDF大小：约 ${formatFileSize(pdfBytes.length)}</p>
                `;
                resultBox.style.display = 'block';
                
                selectedImages = [];
                updateImageFileList();
                
            } catch (error) {
                console.error('转换失败:', error);
                errorBox.innerHTML = `
                    <h3>❌ 转换失败</h3>
                    <p>错误信息：${error.message}</p>
                    <p>请检查图片文件是否有损坏，或尝试调整设置后重试</p>
                `;
                errorBox.style.display = 'block';
            } finally {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    convertBtn.disabled = false;
                }, 2000);
            }
        }

        async function processImagesOnPage(pdfDoc, page, images, settings, pageWidth, pageHeight, cols, rows) {
            const availableWidth = pageWidth - 2 * settings.margin;
            const availableHeight = pageHeight - 2 * settings.margin;
            const cellWidth = availableWidth / cols;
            const cellHeight = availableHeight / rows;
            
            for (let i = 0; i < images.length; i++) {
                const image = images[i];
                const pdfImage = await embedImageInPDF(pdfDoc, image, settings.quality);
                
                const col = i % cols;
                const row = Math.floor(i / cols);
                const x = settings.margin + col * cellWidth;
                const y = pageHeight - settings.margin - (row + 1) * cellHeight; // PDF坐标系原点在左下
                
                drawImageInCell(page, pdfImage, x, y, cellWidth, cellHeight, settings.scale);
            }
        }

        async function embedImageInPDF(pdfDoc, file, quality) {
            const imageBytes = await file.arrayBuffer();
            
            if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
                return await pdfDoc.embedJpg(imageBytes);
            } else if (file.type === 'image/png') {
                return await pdfDoc.embedPng(imageBytes);
            } else {
                // 转换为JPEG
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                await new Promise(resolve => {
                    img.onload = resolve;
                    img.src = URL.createObjectURL(file);
                });
                
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const jpegDataUrl = canvas.toDataURL('image/jpeg', quality);
                const jpegBytes = await fetch(jpegDataUrl).then(res => res.arrayBuffer());
                
                URL.revokeObjectURL(img.src);
                return await pdfDoc.embedJpg(jpegBytes);
            }
        }

        function drawImageInCell(page, pdfImage, x, y, cellWidth, cellHeight, scaleMode) {
            const imageAspect = pdfImage.width / pdfImage.height;
            const cellAspect = cellWidth / cellHeight;
            
            let width, height, offsetX = 0, offsetY = 0;
            
            if (scaleMode === 'fit') {
                if (imageAspect > cellAspect) {
                    width = cellWidth;
                    height = cellWidth / imageAspect;
                    offsetY = (cellHeight - height) / 2;
                } else {
                    height = cellHeight;
                    width = cellHeight * imageAspect;
                    offsetX = (cellWidth - width) / 2;
                }
            } else if (scaleMode === 'fill') {
                if (imageAspect > cellAspect) {
                    height = cellHeight;
                    width = cellHeight * imageAspect;
                    offsetX = (cellWidth - width) / 2;
                } else {
                    width = cellWidth;
                    height = cellWidth / imageAspect;
                    offsetY = (cellHeight - height) / 2;
                }
            } else { // original
                width = Math.min(pdfImage.width, cellWidth);
                height = Math.min(pdfImage.height, cellHeight);
                offsetX = (cellWidth - width) / 2;
                offsetY = (cellHeight - height) / 2;
            }
            
            page.drawImage(pdfImage, { 
                x: x + offsetX, 
                y: y + offsetY, 
                width, 
                height 
            });
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('PDF工具箱完整版已加载完成');
            
            // 设置默认值
            document.getElementById('imageQuality').dispatchEvent(new Event('input'));
        });
    </script>
</body>
</html>
